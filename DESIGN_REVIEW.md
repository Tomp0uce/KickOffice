# KickOffice - Fresh Design Review

**Date**: 2026-02-19
**Scope**: Architecture, Code Quality, State Management, and Maintainability

---

## Executive Summary

After a deep verification of the codebase, it is confirmed that the core execution layers of the application (Agent Chat, API Routing, and Validation) are highly functional. Previous assumptions regarding broken features (e.g., chat failing in Word due to reasoning parameters, missing Vue error handlers, or incomplete Prompts configurations) proved to be inaccurate upon executing and tracing the code.

**However, the project suffers from a significant architectural bottleneck in the frontend:** a massive concentration of logic in a single file (`useAgentLoop.ts`) and conflicting state management practices regarding LocalStorage.

---

## Verified Issues by Severity

### CRITICAL ‚Äî Broken Text Formatting and List Rendering

#### C1. `insertText` strips Markdown formatting in Word and PowerPoint

**Problem**: Text formatting generated by the LLM (like `**bold**`, `*italics*`, lists) appears raw in Word and PowerPoint, or renders as plain web tags.
**Cause**: The agent's tools (`insertText`, `replaceSelectedText`, `insertList`) invoke the native plain text `insertText` for Word and `CoercionType.Text` for PowerPoint. Consequently, any generated Markdown or HTML isn't parsed into native Office formats.
**Implementation Strategy**: Replace Word's `insertText(...)` with `insertHtml(renderOfficeRichHtml(text), ...)` and use PowerPoint's `setSelectedDataAsync` with `CoercionType.Html`. The raw input string must be first run through the Markdown parser. (Fixed ‚úÖ)

---

### HIGH ‚Äî Architectural Bottleneck & State Conflict

#### H1. `useAgentLoop.ts` is a "God Composable"

**Problem**: The file `frontend/src/composables/useAgentLoop.ts` is almost 600 lines long and handles completely distinct business domains.
**Cause**: When refactoring `HomePage.vue`, logic was simply moved into a single massive composable rather than being divided by responsibility. It currently manages:

- Local storage operations for Tool toggling
- Prompt generation templates for all four Office hosts
- UI side-effects (`adjustTextareaHeight`, `scrollToBottom`)
- MS Office API extractions (`Excel.run`, `Word.run`, `getOutlookMailbox`)
- The entire LLM Agent stream/sync looping logic
  **Implementation Strategy**: Break it down into focused composables:

1. `useAgentPrompts.ts` (handles prompt generation logic)
2. `useOfficeSelection.ts` (handles extracting text from Word/Excel/PPT/Outlook)
3. `useAgentLoop.ts` (strictly handles the API fetching and while-loop messaging)

#### H2. LocalStorage serialization conflict for Enabled Tools

**Problem**: There is a constant tug-of-war on the `enabledTools` storage format, defeating signature validation.
**Cause**:

- `useAgentLoop.ts` (lines 184-236) uses a robust versioned format to protect against stale tools: `{ version: 1, signature: "toolA|toolB", enabledToolNames: [...] }`.
- `SettingsPage.vue` (lines 783) simply saves a raw array: `localStorage.setItem('enabledTools', JSON.stringify([...enabledTools.value]))`.
  Whenever the user uses the Settings page, it overwrites the robust object with a raw array. The next time the agent runs, it intercepts the array, transforms it back into the object.
  **Implementation Strategy**: Extract the LocalStorage management logic from `useAgentLoop.ts` into a dedicated utility (e.g., `src/utils/toolStorage.ts`) and import it in both `useAgentLoop.ts` and `SettingsPage.vue` so they share the exact same saving/loading mechanism.

#### H3. Nginx Proxy Manager (NPM) API Routing Failure

**Problem**: When accessing the app via the public HTTPS domain (DuckDNS), the frontend works but Agent interaction fails because calls to `/api/health` or `/api/chat` return `404 Not Found`.
**Cause**: The Nginx Proxy Manager is correctly forwarding the root domain to the frontend container (Port 80/3002). However, it is not configured to split the traffic. By default, NPM routes `https://kickoffice.duckdns.org/api/...` to the frontend, but the frontend doesn't know what `/api/` is. The backend is running on a different port (Port 3003) and must be explicitly routed.
**Implementation Strategy**: In the Nginx Proxy Manager UI, go to the proxy host configuration for your domain. Click on the **Custom Locations** tab. Add two new locations:

1. **Location**: `/api/`
   - **Forward Hostname / IP**: The local LAN IP of the Ubuntu server (or `kickoffice-backend` if using a shared docker network).
   - **Forward Port**: `3003` (or whatever `BACKEND_PORT` you set).
2. **Location**: `/health`
   - **Forward Hostname / IP**: Same backend IP.
   - **Forward Port**: `3003`.

---

### MEDIUM ‚Äî Maintainability & Hardcoding

#### M1. Hardcoded French strings in core logic

**Problem**: Non-localized strings break the multi-language capability of the app.
**Cause**: Strings like `'‚è≥ Analyse de la demande...'` and `'üõë Processus arr√™t√© par l\'utilisateur.'` are hardcoded directly into the TypeScript logic of `useAgentLoop.ts`.
**Implementation Strategy**: Replace them with their respective i18n keys: `t('agentAnalyzing')` and `t('agentStoppedByUser')`.

#### M2. Hardcoded Request Timeout in frontend API

**Problem**: The global request timeout is rigidly set to `45_000` (45 seconds).
**Cause**: `REQUEST_TIMEOUT_MS` is hardcoded in `frontend/src/api/backend.ts`. Depending on the LLM model tier (especially reasoning models), answers can take longer. While the backend has dynamic timeouts, the frontend does not.
**Implementation Strategy**: Move this to `.env` using `import.meta.env.VITE_REQUEST_TIMEOUT_MS` with a default fallback.

#### M3. Broken App Versioning during Build

**Problem**: The app version displayed in the Settings page is permanently stuck at `1.0.0` despite numerous merges.
**Cause**: The frontend (`vite.config.ts`) attempts to run `git rev-parse --short HEAD` to append the commit hash to the version. However, the Docker build isolates the frontend in a `node:alpine` container _without_ `git` installed, and without access to the root `.git` folder. This causes the Git command to silently fail every time, falling back to the hardcoded `1.0.0` from `package.json`.
**Implementation Strategy**: create a simple script (e.g. `Makefile`) to extract the git hash into a `.env` variable (`APP_VERSION`) on the host _before_ running `docker-compose up`.

---

### LOW ‚Äî Code Hygiene

#### L1. Diagnostic / Debug Logs left in production - FIXED

**Problem**: The production console is cluttered with raw state dumps.
**Cause**: Heavy usage of `console.info` with `[KO-VERBOSE-CHAT][REMOVE_ME]` and `[KICKOFFICE_DEBUG]` tags inside core files (`backend.ts` and `useAgentLoop.ts`).
**Implementation Strategy**: Remove these logs entirely to keep the production console clean. FIXED.

#### L2. Repeated Tailwind patterns - FIXED

**Problem**: Repetitive UI classes across Vue components.
**Cause**: UI components rely on long inline Tailwind utility strings instead of leveraging base component classes.
**Implementation Strategy**: Moved common patterns like `rounded-md border border-border bg-surface p-2` into `@layer components` inside `src/index.css` as custom class `.card-base`. FIXED.
