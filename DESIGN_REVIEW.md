# KickOffice - Fresh Design Review

**Date**: 2026-02-19
**Scope**: Architecture, Code Quality, State Management, and Maintainability

---

## Executive Summary

After a deep verification of the codebase, it is confirmed that the core execution layers of the application (Agent Chat, API Routing, and Validation) are highly functional. Previous assumptions regarding broken features (e.g., chat failing in Word due to reasoning parameters, missing Vue error handlers, or incomplete Prompts configurations) proved to be inaccurate upon executing and tracing the code.

**However, the project suffers from a significant architectural bottleneck in the frontend:** a massive concentration of logic in a single file (`useAgentLoop.ts`) and conflicting state management practices regarding LocalStorage.

---

## Verified Issues by Severity

### CRITICAL ‚Äî Broken Text Formatting and List Rendering

#### C1. `insertText` strips Markdown formatting in Word and PowerPoint

**Problem**: Text formatting generated by the LLM (like `**bold**`, `*italics*`, lists) appears raw in Word and PowerPoint, or renders as plain web tags.
**Cause**: The agent's tools (`insertText`, `replaceSelectedText`, `insertList`) invoke the native plain text `insertText` for Word and `CoercionType.Text` for PowerPoint. Consequently, any generated Markdown or HTML isn't parsed into native Office formats.
**Implementation Strategy**: Replace Word's `insertText(...)` with `insertHtml(renderOfficeRichHtml(text), ...)` and use PowerPoint's `setSelectedDataAsync` with `CoercionType.Html`. The raw input string must be first run through the Markdown parser. (Fixed ‚úÖ)

---

### HIGH ‚Äî Architectural Bottleneck & State Conflict

#### H1. `useAgentLoop.ts` is a "God Composable" - FIXED

**Problem**: The file `frontend/src/composables/useAgentLoop.ts` was almost 600 lines long and handled completely distinct business domains.
**Cause**: When refactoring `HomePage.vue`, logic was simply moved into a single massive composable rather than being divided by responsibility. It managed local storage, prompt templates, UI side effects, Office API extractions, and the entire LLM agent loop.
**Implementation Strategy**: Broken down into focused composables:

1. `useAgentPrompts.ts` (handles prompt generation logic and context string building)
2. `useOfficeSelection.ts` (handles extracting text from Word/Excel/PPT/Outlook via native Office DOM APIs)
3. `useAgentLoop.ts` (strictly handles the AI agent streaming/sync loop and chat UI state)
   STATUS: FIXED ‚úÖ

#### H2. LocalStorage serialization conflict for Enabled Tools - FIXED

**Problem**: There is a constant tug-of-war on the `enabledTools` storage format, defeating signature validation.
**Cause**:

- `useAgentLoop.ts` (lines 184-236) uses a robust versioned format to protect against stale tools: `{ version: 1, signature: "toolA|toolB", enabledToolNames: [...] }`.
- `SettingsPage.vue` (lines 783) simply saves a raw array: `localStorage.setItem('enabledTools', JSON.stringify([...enabledTools.value]))`.
  Whenever the user uses the Settings page, it overwrites the robust object with a raw array. The next time the agent runs, it intercepts the array, transforms it back into the object.
  **Implementation Strategy**: Extract the LocalStorage management logic from `useAgentLoop.ts` into a dedicated utility (e.g., `src/utils/toolStorage.ts`) and import it in both `useAgentLoop.ts` and `SettingsPage.vue` so they share the exact same saving/loading mechanism. FIXED.

#### H3. Nginx Proxy Manager (NPM) API Routing Failure - FIXED

**Problem**: When accessing the app via the public HTTPS domain (DuckDNS), the frontend works but Agent interaction fails because calls to `/api/health` or `/api/chat` return `404 Not Found`.
**Cause**: The `PUBLIC_BACKEND_URL` in `.env` was mistakenly set to `https://kickoffice.duckdns.org/api` with a trailing `/api`.
**Implementation Strategy**: Correct the `.env` file to use `https://kickoffice.duckdns.org` without the trailing API suffix. FIXED.

---

### MEDIUM ‚Äî Maintainability & Hardcoding

#### M1. Hardcoded French strings in core logic - FIXED

**Problem**: Non-localized strings break the multi-language capability of the app.
**Cause**: Strings like `'‚è≥ Analyse de la demande...'` and `'üõë Processus arr√™t√© par l\'utilisateur.'` are hardcoded directly into the TypeScript logic of `useAgentLoop.ts`.
**Implementation Strategy**: Replace them with their respective i18n keys: `t('agentAnalyzing')` and `t('agentStoppedByUser')`. FIXED.

#### M2. Hardcoded Request Timeout in frontend API - FIXED

**Problem**: The global request timeout is rigidly set to `45_000` (45 seconds).
**Cause**: `REQUEST_TIMEOUT_MS` is hardcoded in `frontend/src/api/backend.ts`. Depending on the LLM model tier (especially reasoning models), answers can take longer. While the backend has dynamic timeouts, the frontend does not.
**Implementation Strategy**: Move this to `.env` using `import.meta.env.VITE_REQUEST_TIMEOUT_MS` with a default fallback. FIXED.

#### M3. Broken App Versioning during Build - FIXED

**Problem**: The app version displayed in the Settings page is permanently stuck at `1.0.0` despite numerous merges.
**Cause**: The frontend (`vite.config.ts`) attempts to run `git rev-parse --short HEAD` to append the commit hash to the version. However, the Docker build isolates the frontend in a `node:alpine` container _without_ `git` installed, and without access to the root `.git` folder. This causes the Git command to silently fail every time, falling back to the hardcoded `1.0.0` from `package.json`.
**Implementation Strategy**: create a simple script (e.g. `Makefile`) to extract the git hash into a `.env` variable (`APP_VERSION`) on the host _before_ running `docker-compose up`. FIXED.

---

### LOW ‚Äî Code Hygiene

#### L1. Diagnostic / Debug Logs left in production - FIXED

**Problem**: The production console is cluttered with raw state dumps.
**Cause**: Heavy usage of `console.info` with `[KO-VERBOSE-CHAT][REMOVE_ME]` and `[KICKOFFICE_DEBUG]` tags inside core files (`backend.ts` and `useAgentLoop.ts`).
**Implementation Strategy**: Remove these logs entirely to keep the production console clean. FIXED.

#### L2. Repeated Tailwind patterns - FIXED

**Problem**: Repetitive UI classes across Vue components.
**Cause**: UI components rely on long inline Tailwind utility strings instead of leveraging base component classes.
**Implementation Strategy**: Moved common patterns like `rounded-md border border-border bg-surface p-2` into `@layer components` inside `src/index.css` as custom class `.card-base`. FIXED.
